Dapper Lead Salmon

high

# Attackers can siphon off the yield generated by the protocol through flash loans

## Summary

Attackers can siphon off the revenue generated by the protocol through flash loans

## Vulnerability Detail

In Solmate's [ERC4626](https://github.com/transmissions11/solmate/blob/main/src/tokens/ERC4626.sol#L46-L58) instance, `afterDeposit` is called after minting share to the user:

    function deposit(uint256 assets, address receiver) public virtual returns (uint256 shares) {
        // Check for rounding error since we round down in previewDeposit.
        require((shares = previewDeposit(assets)) != 0, "ZERO_SHARES");

        // Need to transfer before minting or ERC777s could reenter.
        asset.safeTransferFrom(msg.sender, address(this), assets);

        _mint(receiver, shares);

        emit Deposit(msg.sender, receiver, assets, shares);

        afterDeposit(assets, shares);
    }

And in `Market.sol`, 

  /// @notice Hook to update the floating pool average, floating pool balance and distribute earnings from accumulator.
  /// @param assets amount of assets to be deposited to the floating pool.
  function afterDeposit(uint256 assets, uint256) internal override whenNotPaused whenNotFrozen {
    updateFloatingAssetsAverage();
    uint256 treasuryFee = updateFloatingDebt();
    uint256 earnings = accrueAccumulatedEarnings();
    floatingAssets += earnings + assets; 
    depositToTreasury(treasuryFee);
    emitMarketUpdate();
  }

The previously accumulated earnings are not distributed until the user has finished minting new shares. This is incorrect because the new shares that have just entered the market also participate in that distribution. 

All user operations should ensure that `totalAssets` is updated before the operation, not after.

## Impact

Malicious users can siphon off market accumulated earnings with flashloan. This attack will have a big impact on markets that have not `accrueAccumulatedEarnings` for a long time and users will lose a lot of earnings.

## Code Snippet

https://github.com/sherlock-audit/2024-04-interest-rate-model/blob/main/protocol/contracts/Market.sol#L710-L717

## Tool used

Manual Review

## Recommendation

Override function `deposit` and move logics in `afterDeposit` into it.
